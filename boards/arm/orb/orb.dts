/dts-v1/;
#include <st/g4/stm32g474Xe.dtsi>
#include <st/g4/stm32g474v(b-c-e)tx-pinctrl.dtsi>

/ {
	model = "Worldcoin Orb";
	compatible = "worldcoin,orb";

	chosen {
		zephyr,console = &usart2;
		zephyr,shell-uart = &usart2;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		// zephyr,can-primary = &can1;
	};

    vbat_sw {
        compatible = "regulator-fixed-sync", "regulator-fixed";
        label = "12V VBAT SW";
        regulator-name = "12v_vbat_sw";
        enable-gpios = <&gpiof 10 GPIO_ACTIVE_HIGH>;
    };

    supply_12v {
        compatible = "regulator-fixed-sync", "regulator-fixed";
        label = "12V Supply";
        regulator-name = "supply_12v";
        enable-gpios = <&gpioe 0 GPIO_ACTIVE_HIGH>;
    };


/* WIP
    pwm_fan {
        compatible = "st,stm32-pwm";
        label = "Fan speed control";
        pinctl-0: <&tim2_ch3_pwm_pd7>;

    };
*/
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(24)>;
	status = "okay";
};

&pll {
	div-m = <6>;
	mul-n = <85>;
	div-p = <7>;
	div-q = <2>;
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(170)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <1>;
	apb2-prescaler = <1>;
};

&usart2 {
	pinctrl-0 = <&usart2_tx_pd5 &usart2_rx_pd6>;
	current-speed = <115200>;
	status = "okay";
};

&rtc {
	status = "okay";
};

/* WIP

&timers2 {
    status = "okay";

    fan_pwm: pwm {
        status = "okay";
        pinctrl-0 = <&tim2_ch3_pd7>;
    };
};

*/

&flash0 {
	/*
	 * For more information, see:
	 * http://docs.zephyrproject.org/latest/guides/dts/index.html#flash-partitions
	 */
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/* Set 2Kb of storage at the end of the 128Kb of flash */
		storage_partition: partition@1f800 {
			label = "storage";
			reg = <0x0001f800 0x00000800>;
		};
	};
};
